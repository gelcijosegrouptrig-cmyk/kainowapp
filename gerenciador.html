<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kainowapp - Gerenciador Admin</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .container { display: flex; min-height: 100vh; }
        
        /* SIDEBAR - TEMA VERDE KAINOW */
        .sidebar {
            width: 280px; 
            background: linear-gradient(180deg, #4C7C7A 0%, #3A5F5D 100%);
            color: white; padding: 20px; position: fixed; height: 100vh; overflow-y: auto;
        }
        
        /* Logo Kainow */
        .logo { 
            width: 60px; height: 60px; 
            background: white; 
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; font-weight: bold; color: #4C7C7A;
            margin: 0 auto 10px;
        }
        .logo-text { font-size: 20px; font-weight: bold; text-align: center; margin-bottom: 30px; }
        
        .admin-info {
            background: rgba(255,255,255,0.1); 
            padding: 15px; border-radius: 10px; margin-bottom: 30px;
        }
        .admin-info h3 { font-size: 16px; margin-bottom: 5px; }
        .admin-info p { font-size: 12px; opacity: 0.8; }
        
        .nav-menu { list-style: none; }
        .nav-item { margin-bottom: 10px; }
        .nav-link {
            display: flex; align-items: center; padding: 12px 15px; color: white;
            text-decoration: none; border-radius: 8px; transition: background 0.3s; cursor: pointer;
        }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.2); }
        .nav-link .icon { margin-right: 12px; font-size: 20px; }
        
        .logout-btn {
            margin-top: 30px; background: rgba(255,0,0,0.3); border: none; color: white;
            padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; 
            font-size: 14px; font-weight: 600;
        }
        .logout-btn:hover { background: rgba(255,0,0,0.5); }

        /* MAIN CONTENT */
        .main-content { margin-left: 280px; flex: 1; padding: 30px; }
        .page { display: none; }
        .page.active { display: block; }
        .page-header { margin-bottom: 30px; }
        .page-header h1 { font-size: 32px; color: #333; margin-bottom: 10px; }
        .page-header p { color: #666; }

        /* CARDS */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; margin-bottom: 30px; 
        }
        .stat-card {
            background: white; padding: 25px; border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .stat-info h3 { font-size: 14px; color: #666; margin-bottom: 10px; }
        .stat-info p { font-size: 32px; font-weight: bold; color: #4C7C7A; }
        .stat-icon { font-size: 48px; opacity: 0.3; color: #4C7C7A; }

        /* TABELA */
        .table-container { 
            background: white; border-radius: 12px; padding: 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
        }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f8f9fa; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e9ecef; }
        th { font-weight: 600; color: #495057; font-size: 14px; }
        td { color: #212529; font-size: 14px; }
        tr:hover { background: #f8f9fa; }

        /* BOT√ïES */
        .btn {
            padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;
            font-size: 14px; font-weight: 600; transition: all 0.3s;
        }
        .btn-primary { background: #4C7C7A; color: white; }
        .btn-primary:hover { background: #3A5F5D; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }

        /* BADGES */
        .badge {
            padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: 600;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }

        /* LOADING */
        .loading {
            display: none; text-align: center; padding: 40px;
        }
        .loading.active { display: block; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4C7C7A;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mensagem de erro/sucesso */
        .alert {
            padding: 15px; border-radius: 8px; margin-bottom: 20px;
        }
        .alert-danger {
            background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;
        }
        .alert-success {
            background: #d4edda; color: #155724; border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="logo">K</div>
            <div class="logo-text">KAINOWAPP</div>
            
            <div class="admin-info">
                <h3 id="adminName">Carregando...</h3>
                <p id="adminEmail">-</p>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" data-page="dashboard">
                        <span class="icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="vendedores">
                        <span class="icon">üë•</span>
                        <span>Vendedores</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="clientes">
                        <span class="icon">üë§</span>
                        <span>Clientes</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="produtos">
                        <span class="icon">üì¶</span>
                        <span>Produtos</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="seguros">
                        <span class="icon">üõ°Ô∏è</span>
                        <span>Seguros</span>
                    </a>
                </li>
            </ul>
            
            <button class="logout-btn" onclick="logout()">
                <span>üö™ Sair</span>
            </button>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- DASHBOARD -->
            <div id="dashboard" class="page active">
                <div class="page-header">
                    <h1>Dashboard</h1>
                    <p>Vis√£o geral do sistema</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Vendedores</h3>
                            <p id="totalVendedores">0</p>
                        </div>
                        <div class="stat-icon">üë•</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Clientes</h3>
                            <p id="totalClientes">0</p>
                        </div>
                        <div class="stat-icon">üë§</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Produtos</h3>
                            <p id="totalProdutos">0</p>
                        </div>
                        <div class="stat-icon">üì¶</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Seguros</h3>
                            <p id="totalSeguros">0</p>
                        </div>
                        <div class="stat-icon">üõ°Ô∏è</div>
                    </div>
                </div>
            </div>

            <!-- VENDEDORES -->
            <div id="vendedores" class="page">
                <div class="page-header">
                    <h1>Vendedores</h1>
                    <p>Gerenciar vendedores cadastrados</p>
                </div>
                
                <div id="loading-vendedores" class="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px; color: #666;">Carregando...</p>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Contato</th>
                                <th>Status</th>
                                <th>Cadastro</th>
                            </tr>
                        </thead>
                        <tbody id="vendedoresTableBody">
                            <tr><td colspan="4" style="text-align: center; color: #999;">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CLIENTES -->
            <div id="clientes" class="page">
                <div class="page-header">
                    <h1>Clientes</h1>
                    <p>Gerenciar clientes cadastrados</p>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Contato</th>
                                <th>Status</th>
                                <th>Cadastro</th>
                            </tr>
                        </thead>
                        <tbody id="clientesTableBody">
                            <tr><td colspan="4" style="text-align: center; color: #999;">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PRODUTOS -->
            <div id="produtos" class="page">
                <div class="page-header">
                    <h1>Produtos</h1>
                    <p>Gerenciar produtos cadastrados</p>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Categoria</th>
                                <th>Pre√ßo</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="produtosTableBody">
                            <tr><td colspan="4" style="text-align: center; color: #999;">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SEGUROS -->
            <div id="seguros" class="page">
                <div class="page-header">
                    <h1>Seguros</h1>
                    <p>Gerenciar seguros cadastrados</p>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Tipo</th>
                                <th>Valor</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="segurosTableBody">
                            <tr><td colspan="4" style="text-align: center; color: #999;">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Configura√ß√£o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBpEhJV3B_zE4WXJ0vY5KqZ8NhXLPyQz9M",
            authDomain: "kainowapp-v2.firebaseapp.com",
            projectId: "kainowapp-v2",
            storageBucket: "kainowapp-v2.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdefghijklmn"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // NAVEGA√á√ÉO
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function() {
                const pageName = this.getAttribute('data-page');
                showPage(pageName);
            });
        });

        function showPage(pageName) {
            // Remover active de todos os links e p√°ginas
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            
            // Ativar link e p√°gina selecionada
            document.querySelector(`[data-page="${pageName}"]`).classList.add('active');
            document.getElementById(pageName).classList.add('active');
            
            // Carregar dados da p√°gina
            if (pageName === 'dashboard') loadDashboard();
            if (pageName === 'vendedores') loadVendedores();
            if (pageName === 'clientes') loadClientes();
            if (pageName === 'produtos') loadProdutos();
            if (pageName === 'seguros') loadSeguros();
        }

        // AUTENTICA√á√ÉO CORRIGIDA - SEM LOOP
        function checkAuth() {
            const appAuth = localStorage.getItem('adminAuth');
            const webAuth = localStorage.getItem('adminSession');
            
            // Verificar autentica√ß√£o do app mobile
            if (appAuth) {
                try {
                    const authData = JSON.parse(appAuth);
                    const now = new Date().getTime();
                    if (authData.expiresAt && now < authData.expiresAt) {
                        document.getElementById('adminName').textContent = authData.name || 'Admin';
                        document.getElementById('adminEmail').textContent = authData.email || authData.phone || '';
                        return true;
                    }
                } catch (e) {
                    console.error('Erro ao verificar auth do app:', e);
                }
            }
            
            // Verificar autentica√ß√£o web
            if (webAuth) {
                try {
                    const sessionData = JSON.parse(webAuth);
                    const loginTime = new Date(sessionData.loginTime).getTime();
                    const now = new Date().getTime();
                    const hoursSinceLogin = (now - loginTime) / (1000 * 60 * 60);
                    
                    if (hoursSinceLogin < 24) {
                        document.getElementById('adminName').textContent = sessionData.name || 'Admin';
                        document.getElementById('adminEmail').textContent = sessionData.email || sessionData.phone || '';
                        return true;
                    } else {
                        localStorage.removeItem('adminSession');
                    }
                } catch (e) {
                    console.error('Erro ao verificar sess√£o web:', e);
                }
            }
            
            // SOLU√á√ÉO DO LOOP: Mostrar mensagem ao inv√©s de redirecionar
            showErrorMessage('Sess√£o expirada. Por favor, fa√ßa login novamente.');
            
            // Redirecionar apenas ap√≥s 2 segundos (tempo para ler a mensagem)
            setTimeout(() => {
                window.location.href = '/gerenciador_login';
            }, 2000);
            
            return false;
        }

        function showErrorMessage(message) {
            const mainContent = document.querySelector('.main-content');
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger';
            alertDiv.innerHTML = `
                <strong>‚ö†Ô∏è Aten√ß√£o!</strong><br>
                ${message}<br>
                <small>Redirecionando para a p√°gina de login...</small>
            `;
            mainContent.insertBefore(alertDiv, mainContent.firstChild);
        }

        function logout() {
            localStorage.removeItem('adminAuth');
            localStorage.removeItem('adminSession');
            window.location.href = '/gerenciador_login';
        }

        // DASHBOARD
        async function loadDashboard() {
            try {
                const vendedores = await db.collection('users').where('role', '==', 'seller').get();
                const clientes = await db.collection('users').where('role', '==', 'buyer').get();
                const produtos = await db.collection('products').get();
                const seguros = await db.collection('insurances').get();
                
                document.getElementById('totalVendedores').textContent = vendedores.size;
                document.getElementById('totalClientes').textContent = clientes.size;
                document.getElementById('totalProdutos').textContent = produtos.size;
                document.getElementById('totalSeguros').textContent = seguros.size;
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
                document.getElementById('totalVendedores').textContent = '-';
                document.getElementById('totalClientes').textContent = '-';
                document.getElementById('totalProdutos').textContent = '-';
                document.getElementById('totalSeguros').textContent = '-';
            }
        }

        // VENDEDORES
        async function loadVendedores() {
            const loading = document.getElementById('loading-vendedores');
            const tbody = document.getElementById('vendedoresTableBody');
            
            loading.classList.add('active');
            tbody.innerHTML = '';
            
            try {
                const snapshot = await db.collection('users').where('role', '==', 'seller').get();
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">Nenhum vendedor encontrado</td></tr>';
                } else {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const tr = document.createElement('tr');
                        
                        const statusBadge = data.status === 'approved' ? 
                            '<span class="badge badge-success">Aprovado</span>' :
                            data.status === 'pending' ?
                            '<span class="badge badge-warning">Pendente</span>' :
                            '<span class="badge badge-danger">Reprovado</span>';
                        
                        const date = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString('pt-BR') : 'N/A';
                        
                        tr.innerHTML = `
                            <td>${data.name || 'N/A'}</td>
                            <td>${data.email || data.phone || 'N/A'}</td>
                            <td>${statusBadge}</td>
                            <td>${date}</td>
                        `;
                        
                        tbody.appendChild(tr);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar vendedores:', error);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #dc3545;">Erro ao carregar dados</td></tr>';
            } finally {
                loading.classList.remove('active');
            }
        }

        // CLIENTES
        async function loadClientes() {
            const tbody = document.getElementById('clientesTableBody');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;"><div class="spinner"></div></td></tr>';
            
            try {
                const snapshot = await db.collection('users').where('role', '==', 'buyer').get();
                tbody.innerHTML = '';
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">Nenhum cliente encontrado</td></tr>';
                } else {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const tr = document.createElement('tr');
                        const date = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString('pt-BR') : 'N/A';
                        const statusBadge = data.status === 'active' ? 
                            '<span class="badge badge-success">Ativo</span>' :
                            '<span class="badge badge-danger">Inativo</span>';
                        
                        tr.innerHTML = `
                            <td>${data.name || 'N/A'}</td>
                            <td>${data.email || data.phone || 'N/A'}</td>
                            <td>${statusBadge}</td>
                            <td>${date}</td>
                        `;
                        
                        tbody.appendChild(tr);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #dc3545;">Erro ao carregar dados</td></tr>';
            }
        }

        // PRODUTOS
        async function loadProdutos() {
            const tbody = document.getElementById('produtosTableBody');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;"><div class="spinner"></div></td></tr>';
            
            try {
                const snapshot = await db.collection('products').get();
                tbody.innerHTML = '';
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">Nenhum produto encontrado</td></tr>';
                } else {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const tr = document.createElement('tr');
                        const price = data.price ? `R$ ${parseFloat(data.price).toFixed(2)}` : 'N/A';
                        const statusBadge = data.status === 'active' ? 
                            '<span class="badge badge-success">Ativo</span>' :
                            '<span class="badge badge-danger">Inativo</span>';
                        
                        tr.innerHTML = `
                            <td>${data.name || 'N/A'}</td>
                            <td>${data.category || 'N/A'}</td>
                            <td>${price}</td>
                            <td>${statusBadge}</td>
                        `;
                        
                        tbody.appendChild(tr);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #dc3545;">Erro ao carregar dados</td></tr>';
            }
        }

        // SEGUROS
        async function loadSeguros() {
            const tbody = document.getElementById('segurosTableBody');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;"><div class="spinner"></div></td></tr>';
            
            try {
                const snapshot = await db.collection('insurances').get();
                tbody.innerHTML = '';
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">Nenhum seguro encontrado</td></tr>';
                } else {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const tr = document.createElement('tr');
                        const value = data.value ? `R$ ${parseFloat(data.value).toFixed(2)}` : 'N/A';
                        const statusBadge = data.status === 'active' ? 
                            '<span class="badge badge-success">Ativo</span>' :
                            '<span class="badge badge-danger">Inativo</span>';
                        
                        tr.innerHTML = `
                            <td>${data.name || 'N/A'}</td>
                            <td>${data.type || 'N/A'}</td>
                            <td>${value}</td>
                            <td>${statusBadge}</td>
                        `;
                        
                        tbody.appendChild(tr);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar seguros:', error);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #dc3545;">Erro ao carregar dados</td></tr>';
            }
        }

        // INICIALIZA√á√ÉO
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autentica√ß√£o ao carregar
            if (checkAuth()) {
                // Carregar dashboard inicial
                loadDashboard();
            }
        });
    </script>
</body>
</html>
